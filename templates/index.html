<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confluence Auto-Summarization</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
        // ì¦‰ì‹œ ë¡œë“œë˜ëŠ” ì „ì—­ í•¨ìˆ˜ë“¤
        async function handleKeywordMindmap() {
            console.log('ğŸš€ handleKeywordMindmap ì¦‰ì‹œ í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            try {
                const response = await fetch('/keywords');
                console.log('ğŸ“¡ í‚¤ì›Œë“œ API ì‘ë‹µ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const keywords = await response.json();
                console.log('ğŸ“‹ í‚¤ì›Œë“œ ëª©ë¡:', keywords.length, 'ê°œ');
                
                if (keywords.length === 0) {
                    alert('ì €ì¥ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Confluence í˜ì´ì§€ë¥¼ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ê°„ë‹¨í•œ í‚¤ì›Œë“œ ì„ íƒ
                const keyword = prompt(`í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n${keywords.slice(0, 10).join('\n')}\n\nìœ„ ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
                
                console.log('ğŸ” ì…ë ¥ëœ í‚¤ì›Œë“œ:', keyword);
                console.log('ğŸ“‹ í‚¤ì›Œë“œ ëª©ë¡ì— í¬í•¨ ì—¬ë¶€:', keywords.includes(keyword));
                console.log('ğŸ“‹ í‚¤ì›Œë“œ ëª©ë¡ ìƒ˜í”Œ:', keywords.slice(0, 10));
                
                if (keyword) {
                    if (keywords.includes(keyword)) {
                        console.log('âœ… í‚¤ì›Œë“œ ì„ íƒë¨:', keyword);
                        const url = `/mindmap?mode=keyword&keyword=${encodeURIComponent(keyword)}`;
                        console.log('ğŸ”— ìƒì„±ëœ URL:', url);
                        console.log('ğŸš€ ìƒˆ ì°½ ì—´ê¸° ì‹œë„...');
                        
                        // ìƒˆ ì°½ ì—´ê¸° ì‹œë„
                        const newWindow = window.open(url, '_blank');
                        
                        // íŒì—… ì°¨ë‹¨ í™•ì¸
                        if (newWindow) {
                            console.log('âœ… ìƒˆ ì°½ ì—´ê¸° ì„±ê³µ');
                        } else {
                            console.log('âŒ ìƒˆ ì°½ ì—´ê¸° ì‹¤íŒ¨ (íŒì—… ì°¨ë‹¨?), ê°™ì€ ì°½ì—ì„œ ì´ë™');
                            if (confirm('ìƒˆ ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì°½ì—ì„œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                window.location.href = url;
                            }
                        }
                    } else {
                        console.log('âŒ ìœ íš¨í•˜ì§€ ì•Šì€ í‚¤ì›Œë“œ:', keyword);
                        // ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰
                        const keywordLower = keyword.toLowerCase();
                        const matchedKeyword = keywords.find(k => k.toLowerCase() === keywordLower);
                        
                        if (matchedKeyword) {
                            console.log('ğŸ”„ ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ë§¤ì¹­ë¨:', matchedKeyword);
                            const url = `/mindmap?mode=keyword&keyword=${encodeURIComponent(matchedKeyword)}`;
                            console.log('ğŸ”— ìƒì„±ëœ URL:', url);
                            
                            const newWindow = window.open(url, '_blank');
                            if (!newWindow) {
                                console.log('âŒ ìƒˆ ì°½ ì—´ê¸° ì‹¤íŒ¨, ê°™ì€ ì°½ì—ì„œ ì´ë™');
                                if (confirm('ìƒˆ ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì°½ì—ì„œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                    window.location.href = url;
                                }
                            }
                        } else {
                            alert(`ìœ íš¨í•˜ì§€ ì•Šì€ í‚¤ì›Œë“œì…ë‹ˆë‹¤.\nì…ë ¥: "${keyword}"\n\nì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ì›Œë“œ:\n${keywords.slice(0, 10).join('\n')}`);
                        }
                    }
                } else {
                    console.log('ğŸš« í‚¤ì›Œë“œ ì…ë ¥ ì·¨ì†Œë¨');
                }
                
            } catch (error) {
                console.error('âŒ í‚¤ì›Œë“œ ë§ˆì¸ë“œë§µ ì˜¤ë¥˜:', error);
                alert(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            }
        }
        
        async function handleAllMindmap() {
            console.log('ğŸš€ handleAllMindmap í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            try {
                const response = await fetch('/pages/stats');
                const stats = await response.json();
                
                if (stats.total_pages === 0) {
                    alert('ì €ì¥ëœ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Confluence í˜ì´ì§€ë¥¼ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                console.log('ì „ì²´ ë§ˆì¸ë“œë§µ í˜ì´ì§€ë¡œ ì´ë™');
                window.open('/mindmap?mode=all', '_blank');
                
            } catch (error) {
                console.error('ì „ì²´ ë§ˆì¸ë“œë§µ ì˜¤ë¥˜:', error);
                alert('ì „ì²´ ë§ˆì¸ë“œë§µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        function handleSpecificMindmap() {
            console.log('ğŸš€ handleSpecificMindmap í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            const pageId = prompt('ë§ˆì¸ë“œë§µì„ ìƒì„±í•  í˜ì´ì§€ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (!pageId) {
                return;
            }
            
            if (!/^\d+$/.test(pageId.trim())) {
                alert('ìœ íš¨í•œ í˜ì´ì§€ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìˆ«ìë§Œ)');
                return;
            }
            
            console.log('í˜ì´ì§€ ë§ˆì¸ë“œë§µìœ¼ë¡œ ì´ë™:', pageId);
            window.open(`/mindmap?parent_id=${pageId.trim()}`, '_blank');
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Confluence Auto-Summarization System</h1>
            <p>Confluence í˜ì´ì§€ ìë™ ìš”ì•½ ë° í‚¤ì›Œë“œ ì¶”ì¶œ ì‹œìŠ¤í…œ</p>
            <nav style="margin-top: 15px;">
                <a href="/data" class="btn btn-info">ë°ì´í„° ì¡°íšŒ</a>
                <button id="viewAllMindmap" class="btn btn-secondary" onclick="handleAllMindmap()">ì „ì²´ ë§ˆì¸ë“œë§µ</button>
                <button id="viewSpecificMindmap" class="btn btn-primary" onclick="handleSpecificMindmap()">í˜ì´ì§€ ë§ˆì¸ë“œë§µ</button>
                <button id="viewKeywordMindmap" class="btn btn-success" onclick="handleKeywordMindmap()">í‚¤ì›Œë“œ ë§ˆì¸ë“œë§µ</button>
            </nav>
        </header>
        
        <!-- ì—°ê²° ì„¤ì • ì„¹ì…˜ -->
        <section class="card">
            <h2>Confluence ì—°ê²° ì„¤ì •</h2>
            <form id="connectionForm">
                <div class="form-group">
                    <label for="confluenceUrl">Confluence URL:</label>
                    <input type="url" id="confluenceUrl" placeholder="https://your-confluence.com" required>
                </div>
                <div class="form-group">
                    <label for="username">ì‚¬ìš©ì ID:</label>
                    <input type="text" id="username" placeholder="ì‚¬ìš©ì ID" required>
                </div>
                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸:</label>
                    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                </div>
                <button type="button" id="testConnection" class="btn btn-primary">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            </form>
            <div id="connectionStatus" class="status-message"></div>
        </section>
        
        <!-- í˜ì´ì§€ ì²˜ë¦¬ ì„¹ì…˜ -->
        <section class="card">
            <h2>í˜ì´ì§€ ì²˜ë¦¬</h2>
            <form id="processForm">
                <div class="form-group">
                    <label for="pageId">ë¶€ëª¨ í˜ì´ì§€ ID:</label>
                    <input type="text" id="pageId" placeholder="ì˜ˆ: 123456789" required>
                    <small>Confluence í˜ì´ì§€ì˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>
                <button type="submit" id="processPages" class="btn btn-success" disabled>ì²˜ë¦¬ ì‹œì‘</button>
            </form>
            <div id="processStatus" class="status-message"></div>
            <div id="progressBar" class="progress-bar" style="display: none;">
                <div class="progress-fill"></div>
                <span class="progress-text">0%</span>
            </div>
        </section>
        
        <!-- ê²°ê³¼ í‘œì‹œ ì„¹ì…˜ -->
        <section class="card">
            <h2>ì²˜ë¦¬ ê²°ê³¼</h2>
            <div id="results" class="results-container"></div>
            <div class="action-buttons">
                <button id="viewMindmap" class="btn btn-info" disabled>ë§ˆì¸ë“œë§µ ë³´ê¸°</button>
                <button id="downloadResults" class="btn btn-secondary" disabled>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </section>
        
        <!-- ë¡œê·¸ ì„¹ì…˜ -->
        <section class="card">
            <h2>ì²˜ë¦¬ ë¡œê·¸</h2>
            <div id="logContainer" class="log-container">
                <pre id="logContent">ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</pre>
            </div>
        </section>
    </div>
    
    <script src="/static/main.js"></script>
</body>
</html>